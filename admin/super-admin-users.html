<!DOCTYPE html>
<html lang="tr" class="light-style layout-navbar-fixed layout-menu-fixed" dir="ltr" data-theme="theme-default" data-assets-path="../admin/assets/" data-template="vertical-menu-template">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>Kullanıcılar | Süperadmin | Envanter360</title>
    <meta name="description" content="Envanter360 süperadmin kullanıcı listesi" />
     <!-- Include Vuexy core CSS and vendor CSS here -->
    <link rel="icon" type="image/x-icon" href="../admin/assets/img/favicon/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="../admin/assets/vendor/fonts/fontawesome.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/fonts/tabler-icons.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/fonts/flag-icons.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/css/rtl/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="../admin/assets/vendor/css/rtl/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="../admin/assets/css/demo.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/libs/node-waves/node-waves.css" />
    <link rel="stylesheet" href="../admin/assets/vendor/libs/typeahead-js/typeahead.css" />
  
  </head>
  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Sidebar / Superadmin Navigation -->
        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo">
            <a href="index.html" class="app-brand-link">
              <span class="app-brand-logo demo">
                <!-- Logo placeholder -->
              </span>
              <span class="app-brand-text demo menu-text fw-bold">Envanter360</span>
            </a>
            <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
              <i class="ti menu-toggle-icon d-none d-xl-block ti-sm align-middle"></i>
              <i class="ti ti-x d-block d-xl-none ti-sm align-middle"></i>
            </a>
          </div>
          <div class="menu-inner-shadow"></div>
          <ul class="menu-inner py-1 navigation navigation-main">
            <li class="menu-item ">
              <a href="../admin/super-admin-dashboard.html" class="menu-link">
                <i class="menu-icon tf-icons ti ti-smart-home"></i>
                <div>Süper Admin Paneli</div>
              </a>
            </li>
            <li class="menu-item active" >
              <a href="../admin/super-admin-users.html" class="menu-link">
                <i class="menu-icon tf-icons ti ti-users"></i>
                <div>Kullanıcılar</div>
              </a>
            </li>
            <li class="menu-item ">
              <a href="../admin/super-admin-plans.html" class="menu-link">
                <i class="menu-icon tf-icons ti ti-layers-intersect"></i>
                <div>Abonelik Planları</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="../admin/super-admin-logs.html" class="menu-link">
                <i class="menu-icon tf-icons ti ti-clipboard-text"></i>
                <div>Sistem Logları</div>
              </a>
            </li>
          </ul>
        </aside>
        <!-- / Sidebar / Superadmin Navigation -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          <nav class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar">
            <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
              <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
                <i class="ti ti-menu-2 ti-sm"></i>
              </a>
            </div>
            <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <li class="nav-item lh-1 me-3 text-muted">Süperadmin</li>
                <li class="nav-item navbar-dropdown dropdown-user dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <div class="avatar avatar-online">
                      <img src="../admin/assets/img/avatars/1.png" alt="Avatar" class="rounded-circle" />
                    </div>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="javascript:void(0);">Profil</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);">Ayarlar</a></li>
                    <li><div class="dropdown-divider"></div></li>
                    <li><a class="dropdown-item" href="javascript:void(0);">Çıkış</a></li>
                  </ul>
                </li>
              </ul>
            </div>
          </nav>
          <!-- / Navbar -->

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <!-- Page Header -->
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
                <div>
                  <h4 class="fw-bold mb-1">Kullanıcılar</h4>
                  <p class="text-muted mb-0">Tüm belediyelerdeki kullanıcıları yönetin.</p>
                </div>
              
              </div>

              <!-- Filters & Actions Card -->
              <div class="card mb-4">
                <div class="card-header d-flex flex-wrap justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">Kullanıcı Filtreleri</h5>
                    <small class="text-muted">Ad, e-posta, belediye, rol ve duruma göre arayın.</small>
                  </div>
                  <a href="/admin/super-admin-create-user.html" class="btn btn-primary mt-2 mt-sm-0">
                    <i class="ti ti-user-plus me-1"></i> Yeni Kullanıcı Ekle
                  </a>
                </div>
                <div class="card-body">
                  <form class="row gy-3 gx-3 align-items-end" id="user-filter-form">
                    <div class="col-12 col-md-4 col-lg-3">
                      <label class="form-label" for="filter-name">Ad / Soyad</label>
                      <input type="text" id="filter-name" name="filter-name" class="form-control" placeholder="Kullanıcı adı ile ara" />
                    </div>
                    <div class="col-12 col-md-4 col-lg-3">
                      <label class="form-label" for="filter-email">E-posta</label>
                      <input type="email" id="filter-email" name="filter-email" class="form-control" placeholder="ornek@belediye.gov.tr" />
                    </div>
                    <div class="col-12 col-md-4 col-lg-2">
                      <label class="form-label" for="filter-municipality">Belediye</label>
                      <select id="filter-municipality" name="filter-municipality" class="form-select">
                        <option value="">Tümü</option>
                        <option value="urla">Urla Belediyesi</option>
                        <option value="konak">Konak Belediyesi</option>
                        <option value="yenisehir">Yenişehir Belediyesi</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-4 col-lg-2">
                      <label class="form-label" for="filter-role">Rol</label>
                      <select id="filter-role" name="filter-role" class="form-select">
                        <option value="">Tümü</option>
                        <option value="2">Taşınır Kayıt Yetkilisi</option>
                        <option value="3">Taşınır Kontrol Yetkilisi</option>
                        <option value="4">Birim Sorumlusu</option>
                        <option value="5">Kullanıcı</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-4 col-lg-2">
                      <label class="form-label" for="filter-status">Durum</label>
                      <select id="filter-status" name="filter-status" class="form-select">
                        <option value="">Tümü</option>
                        <option value="active">Aktif</option>
                        <option value="passive">Pasif</option>
                        <option value="pending">Beklemede</option>
                      </select>
                    </div>
                    <div class="col-12 d-flex gap-2 mt-2">
                      <button type="submit" class="btn btn-primary"><i class="ti ti-filter me-1"></i> Filtrele</button>
                      <button type="reset" class="btn btn-outline-secondary">Temizle</button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Users Table and Analytics -->
              <div class="row">
                <div class="col-12 col-xl-9">
                  <!-- Users Table Card -->
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Kullanıcılar</h5>
                      <span class="badge bg-label-primary" id="users-total">Toplam: 152</span>
                    </div>
                    <div class="table-responsive text-nowrap">
                      <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                          <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>E-posta</th>
                            <th>Belediye</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Son Giriş</th>
                            <th>Oluşturulma Tarihi</th>
                            <th>İşlemler</th>
                          </tr>
                        </thead>
                         <tbody id="users-table-body">
                          <tr>
                            <td colspan="9" class="text-center text-muted py-4">Kullanıcılar yükleniyor...</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-center">
                      <small class="text-muted mb-2 mb-md-0" id="users-pagination-info">Gösterilen: 1–10 / 152</small>
                      <nav aria-label="Kullanıcılar sayfalandırma">
                        <ul class="pagination pagination-sm mb-0">
                          <li class="page-item disabled"><a class="page-link" href="javascript:void(0);" aria-label="Önceki"><i class="ti ti-chevron-left"></i></a></li>
                          <li class="page-item active"><a class="page-link" href="javascript:void(0);">1</a></li>
                          <li class="page-item"><a class="page-link" href="javascript:void(0);">2</a></li>
                          <li class="page-item"><a class="page-link" href="javascript:void(0);">3</a></li>
                          <li class="page-item"><a class="page-link" href="javascript:void(0);" aria-label="Sonraki"><i class="ti ti-chevron-right"></i></a></li>
                        </ul>
                      </nav>
                    </div>
                  </div>
                </div>

                <!-- Right Column Analytics (Optional) -->
                <div class="col-12 col-xl-3 mt-4 mt-xl-0">
                  <div class="card mb-4">
                    <div class="card-header">
                      <h6 class="mb-0">Rol Dağılımı</h6>
                      <small class="text-muted">Kullanıcı rollerinin genel dağılımı</small>
                    </div>
                    <!-- <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between align-items-center">Superadmin <span class="badge bg-label-danger">2 kullanıcı</span></li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">Belediye Yöneticisi <span class="badge bg-label-info">12 kullanıcı</span></li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">Birim Sorumlusu <span class="badge bg-label-primary">35 kullanıcı</span></li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">Personel <span class="badge bg-label-secondary">103 kullanıcı</span></li>
                    </ul> -->
                    <ul class="list-group list-group-flush" id="role-distribution-list">
                      <li class="list-group-item text-muted">Veriler yükleniyor...</li>
                      </ul>
                  </div>
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">Durum Dağılımı</h6>
                      <small class="text-muted">Aktif, pasif ve bekleyen kullanıcılar</small>
                    </div>
                    <!-- <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex justify-content-between align-items-center">Aktif <span class="badge badge-light-success">140</span></li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">Pasif <span class="badge badge-light-secondary">8</span></li>
                      <li class="list-group-item d-flex justify-content-between align-items-center">Beklemede <span class="badge badge-light-warning">4</span></li>
                    </ul> -->
                     <ul class="list-group list-group-flush" id="status-distribution-list">
                      <li class="list-group-item text-muted">Veriler yükleniyor...</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- / Content -->

            <!-- Footer -->
            <footer class="content-footer footer bg-footer-theme">
              <div class="container-xxl d-flex flex-wrap justify-content-between py-2 flex-md-row flex-column">
                <div class="mb-2 mb-md-0">© 2024 Envanter360</div>
                <div class="d-none d-lg-inline-block"><a href="javascript:void(0);" class="footer-link me-3">Gizlilik</a><a href="javascript:void(0);" class="footer-link">Şartlar</a></div>
              </div>
            </footer>
            <!-- / Footer -->

            <div class="content-backdrop fade"></div>
          </div>
          <!-- / Content wrapper -->
        </div>
        <!-- / Layout container -->
      </div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Include Vuexy core JS and vendor JS here -->
  </body>
   <script>
      (() => {
        const API_URL = 'http://localhost:4000/api/superadmin/users/all';
        const tableBody = document.getElementById('users-table-body');
        const totalBadge = document.getElementById('users-total');
        const paginationInfo = document.getElementById('users-pagination-info');
        const roleDistributionList = document.getElementById('role-distribution-list');
        const statusDistributionList = document.getElementById('status-distribution-list');

        const setTableMessage = (message) => {
          tableBody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center text-muted py-4">${message}</td>
            </tr>
          `;
        };

        const formatDate = (value) => {
          if (!value) return '—';
          const date = new Date(value);
          return date.toLocaleDateString('tr-TR');
        };

        const formatDateTime = (value) => {
          if (!value) return '—';
          const date = new Date(value);
          return date.toLocaleString('tr-TR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          });
        };

        const getRoleBadgeClass = (roleName = '') => {
          const normalized = roleName.toLowerCase();

          if (normalized.includes('superadmin')) return 'badge bg-label-danger';
          if (normalized.includes('yönetici') || normalized.includes('manager')) return 'badge bg-label-info';
          if (normalized.includes('birim')) return 'badge bg-label-primary';
          if (normalized.includes('personel') || normalized.includes('staff')) return 'badge bg-label-secondary';

          return 'badge bg-label-secondary';
        };

        const renderRoleDistribution = (users) => {
          roleDistributionList.innerHTML = '';

          const roleCounts = users.reduce((acc, user) => {
            const roleName = user.role_name || 'Rol belirtilmedi';
            acc[roleName] = (acc[roleName] || 0) + 1;
            return acc;
          }, {});

          if (Object.keys(roleCounts).length === 0) {
            roleDistributionList.innerHTML = '<li class="list-group-item text-muted">Rol bilgisi bulunamadı</li>';
            return;
          }

          Object.entries(roleCounts).forEach(([roleName, count]) => {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.innerHTML = `${roleName} <span class="${getRoleBadgeClass(roleName)}">${count} kullanıcı</span>`;
            roleDistributionList.appendChild(item);
          });
        };

        const renderStatusDistribution = (users) => {
          statusDistributionList.innerHTML = '';

          const statusCounts = users.reduce(
            (acc, user) => {
              const statusKey = user.is_active === true ? 'Aktif' : user.is_active === false ? 'Pasif' : 'Beklemede';
              acc[statusKey] = (acc[statusKey] || 0) + 1;
              return acc;
            },
            {}
          );

          if (Object.keys(statusCounts).length === 0) {
            statusDistributionList.innerHTML = '<li class="list-group-item text-muted">Durum bilgisi bulunamadı</li>';
            return;
          }

          const badgeClasses = {
            Aktif: 'badge badge-light-success',
            Pasif: 'badge badge-light-secondary',
            Beklemede: 'badge badge-light-warning',
          };

          Object.entries(statusCounts).forEach(([status, count]) => {
            const item = document.createElement('li');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            const badgeClass = badgeClasses[status] || 'badge bg-label-secondary';
            item.innerHTML = `${status} <span class="${badgeClass}">${count}</span>`;
            statusDistributionList.appendChild(item);
          });
        };

        const renderUsers = (users) => {
          if (!Array.isArray(users) || users.length === 0) {
            totalBadge.textContent = 'Toplam: 0';
            paginationInfo.textContent = 'Gösterilen: 0 / 0';
            setTableMessage('Kullanıcı bulunamadı');
            renderRoleDistribution([]);
            renderStatusDistribution([]);
            return;
          }

          tableBody.innerHTML = '';

          users.forEach((user) => {
            const row = document.createElement('tr');
            row.dataset.userId = user.id;

            const statusBadge = user.is_active === false ? 'badge badge-light-secondary' : 'badge badge-light-success';
            const statusLabel = user.is_active === false ? 'Pasif' : 'Aktif';
            const roleName = user.role_name || 'Rol belirtilmedi';

            row.innerHTML = `
              <td>${user.id ?? '—'}</td>
              <td>${user.full_name || '—'}</td>
              <td>${user.email || '—'}</td>
              <td>${user.municipality_name || '—'}</td>
              <td><span class="${getRoleBadgeClass(roleName)}">${roleName}</span></td>
              <td><span class="${statusBadge}">${statusLabel}</span></td>
              <td>${formatDateTime(user.last_login_at)}</td>
              <td>${formatDate(user.created_at)}</td>
              <td class="d-flex gap-1">
                <a href="superadmin-user-detail.html?id=${user.id}" class="btn btn-sm btn-outline-primary" title="Detay">Detay</a>
                <a href="superadmin-user-edit.html?id=${user.id}" class="btn btn-sm btn-outline-secondary" title="Düzenle">Düzenle</a>
                <a href="superadmin-user-reset-password.html?id=${user.id}" class="btn btn-sm btn-outline-warning" title="Şifre Sıfırla">Şifre Sıfırla</a>
                <button type="button" class="btn btn-sm btn-outline-${user.is_active === false ? 'success' : 'danger'}" title="${user.is_active === false ? 'Aktif Yap' : 'Pasif Yap'}">${user.is_active === false ? 'Aktif Yap' : 'Pasif Yap'}</button>
              </td>
            `;

            tableBody.appendChild(row);
          });

          totalBadge.textContent = `Toplam: ${users.length}`;
          paginationInfo.textContent = `Gösterilen: 1–${users.length} / ${users.length}`;

          renderRoleDistribution(users);
          renderStatusDistribution(users);
        };

        const fetchUsers = async () => {
          try {
            const token = localStorage.getItem('token');
            const response = await fetch(API_URL, {
              headers: token
                ? {
                    Authorization: `Bearer ${token}`,
                  }
                : {},
            });

            if (!response.ok) {
              throw new Error('API isteği başarısız');
            }

            const data = await response.json();
            const users = Array.isArray(data) ? data : [];

            renderUsers(users);
          } catch (error) {
            console.error('Kullanıcılar yüklenirken hata oluştu:', error);
            totalBadge.textContent = 'Toplam: 0';
            paginationInfo.textContent = 'Gösterilen: 0 / 0';
            setTableMessage('Kullanıcılar yüklenemedi');
            roleDistributionList.innerHTML = '<li class="list-group-item text-muted">Rol dağılımı hesaplanamadı</li>';
            statusDistributionList.innerHTML = '<li class="list-group-item text-muted">Durum dağılımı hesaplanamadı</li>';
          }
        };

        fetchUsers();
      })();
    </script>
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const filterForm = document.getElementById('user-filter-form');
    const nameInput = document.getElementById('filter-name');
    const emailInput = document.getElementById('filter-email');
    const municipalitySelect = document.getElementById('filter-municipality');
    const roleSelect = document.getElementById('filter-role');
    const statusSelect = document.getElementById('filter-status');

    const applyFilters = () => {
      const nameValue = nameInput.value.trim().toLowerCase();
      const emailValue = emailInput.value.trim().toLowerCase();
      const municipalityValue = municipalitySelect.value.trim().toLowerCase();
      const roleValue = roleSelect.value.trim();      // superadmin / manager / unit / staff
      const statusValue = statusSelect.value.trim();  // active / passive / pending

      const tableBody = document.getElementById('users-table-body');
      const tableRows = tableBody.querySelectorAll('tr');

      tableRows.forEach((row) => {
        const nameCell = row.querySelector('td:nth-child(2)');
        const emailCell = row.querySelector('td:nth-child(3)');
        const municipalityCell = row.querySelector('td:nth-child(4)');
        const roleCell = row.querySelector('td:nth-child(5)');
        const statusCell = row.querySelector('td:nth-child(6)');

        // Placeholder satırı (örneğin "Kullanıcılar yükleniyor...") ise doğrudan gösterelim
        if (!nameCell || !emailCell || !municipalityCell || !roleCell || !statusCell) {
          row.style.display = '';
          return;
        }

        const nameText = nameCell.textContent.toLowerCase();
        const emailText = emailCell.textContent.toLowerCase();
        const municipalityText = municipalityCell.textContent.toLowerCase();
        const roleText = roleCell.textContent.toLowerCase();
        const statusText = statusCell.textContent.toLowerCase();

        // Ad / Soyad filtresi (içeriyorsa geçsin)
        const matchName =
          !nameValue || nameText.includes(nameValue);

        // E-posta filtresi
        const matchEmail =
          !emailValue || emailText.includes(emailValue);

        // Belediye filtresi (select value: "urla", "konak", "yenisehir"
        // tablo: "Urla Belediyesi" vb. => substring kontrolü iş görür)
        const matchMunicipality =
          !municipalityValue || municipalityText.includes(municipalityValue);

        // Rol filtresi – select value'larını role yazılarındaki ifadelere map edelim
        let matchRole = true;
        if (roleValue) {
          if (roleValue === 'superadmin') {
            matchRole = roleText.includes('superadmin');
          } else if (roleValue === 'manager') {
            // "Belediye Yöneticisi" ifadesini yakalamak için
            matchRole = roleText.includes('yönetici');
          } else if (roleValue === 'unit') {
            matchRole = roleText.includes('birim');
          } else if (roleValue === 'staff') {
            matchRole = roleText.includes('personel') || roleText.includes('staff');
          }
        }

        // Durum filtresi – tablo: "Aktif", "Pasif" (ileride "Beklemede" de gelebilir)
        let matchStatus = true;
        if (statusValue) {
          if (statusValue === 'active') {
            matchStatus = statusText.includes('aktif');
          } else if (statusValue === 'passive') {
            matchStatus = statusText.includes('pasif');
          } else if (statusValue === 'pending') {
            matchStatus = statusText.includes('beklemede');
          }
        }

        const visible =
          matchName &&
          matchEmail &&
          matchMunicipality &&
          matchRole &&
          matchStatus;

        row.style.display = visible ? '' : 'none';
      });
    };

    filterForm?.addEventListener('submit', (event) => {
      event.preventDefault();
      applyFilters();
    });

    filterForm?.addEventListener('reset', () => {
      // reset ile inputlar temizlendikten sonra tüm satırları tekrar göster
      setTimeout(applyFilters, 0);
    });
  });
</script>
</html>